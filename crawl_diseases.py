import requests
from bs4 import BeautifulSoup
import json
import time

def get_wiki_data(query):
    base_url = "https://ko.wikipedia.org/wiki/"
    search_url = base_url + query

    try:
        response = requests.get(search_url, timeout=10)
        response.raise_for_status() # HTTP 오류 발생 시 예외 발생 (4xx, 5xx)
        soup = BeautifulSoup(response.text, 'html.parser')

        data = {
            "병명": query,
            "정의": "",
            "증상": [],
            "원인": [],
            "대처법/치료법": [],
            "추천_약": [],
            "주의사항/생활습관": [],
            "출처": search_url
        }

        first_paragraph = soup.find('p')
        if first_paragraph:
            data["정의"] = first_paragraph.get_text().strip()
        
        # NOTE: 위키백과 구조에 따라 증상, 원인 등을 파싱하는 코드는 여기에 추가되어야 합니다.
        # 현재는 정의만 가져오는 기본 로직입니다.

        print(f"'{query}' 정보 수집 완료.")
        return data

    except requests.exceptions.RequestException as e:
        print(f"오류 발생: '{query}' 정보 수집 중 웹 요청 오류: {e}")
        return None
    except Exception as e:
        print(f"오류 발생: '{query}' 정보 수집 중 알 수 없는 오류: {e}")
        return None

# 수동으로 정의된 병명 정보
# 구글 검색을 통해 일반적인 정보들을 간략하게 요약했습니다.
# 출처는 구글 검색에서 확인된 신뢰성 있는 의료 관련 웹사이트들을 기반으로 합니다.
manual_disease_info = {
    "광선_각화증": {
        "병명": "광선_각화증",
        "정의": "햇빛에 장기간 노출되어 피부 각질형성 세포에 이상이 생겨 발생하는 질환으로, 피부암(편평세포암)으로 진행될 수 있는 전암성 병변입니다.",
        "증상": ["거칠고 건조한 반점", "붉은색, 갈색, 분홍색 또는 피부색", "만지면 사포처럼 느껴짐", "주로 얼굴, 손등, 팔 등 햇빛 노출 부위에 발생"],
        "원인": ["만성적인 자외선 노출"],
        "대처법/치료법": ["냉동치료 (액체 질소)", "광역동 치료", "국소 도포제 (5-플루오로우라실, 이미퀴모드 등)", "레이저 치료", "수술적 절제"],
        "추천_약": ["5-플루오로우라실(5-FU) 연고", "이미퀴모드(Imiquimod) 크림", "디클로페낙(Diclofenac) 젤"],
        "주의사항/생활습관": ["자외선 차단제 꾸준히 사용 (SPF 30 이상)", "모자, 긴팔 옷 등으로 햇빛 노출 최소화", "정기적인 피부과 검진"],
        "출처": "Google 검색 (국립암센터, 대한피부과학회 관련 자료)"
    },
    "멜라닌_세포모반": {
        "병명": "멜라닌_세포모반",
        "정의": "멜라닌 색소 형성 세포인 모반 세포의 증식으로 인해 발생하는 양성 종양으로, 일반적으로 '점'이라고 불립니다.",
        "증상": ["다양한 크기와 모양의 갈색 또는 검은색 반점", "납작하거나 융기된 형태", "대부분 통증이나 가려움 없음"],
        "원인": ["유전적 요인", "자외선 노출"],
        "대처법/치료법": ["대부분 치료 불필요", "미용 목적 또는 악성 변화 의심 시 제거 (레이저, 수술)"],
        "추천_약": ["해당 없음 (약물 치료보다는 제거 시술)"],
        "주의사항/생활습관": ["점의 모양, 크기, 색깔 변화 주시", "가려움, 출혈 등 이상 증상 발생 시 피부과 진찰", "과도한 자외선 노출 피하기"],
        "출처": "Google 검색 (서울대학교병원, 삼성서울병원 관련 자료)"
    },
    "보웬병": {
        "병명": "보웬병",
        "정의": "표피 내에 국한된 편평세포암의 일종으로, 아직 진피를 침범하지 않은 초기 피부암입니다. 표재성 편평세포암이라고도 불립니다.",
        "증상": ["붉은색 또는 갈색의 편평한 판", "경계가 명확하고 표면이 거칠거나 인설(비늘) 동반", "주로 햇빛 노출 부위, 다리, 몸통에 발생"],
        "원인": ["자외선 노출", "인유두종바이러스(HPV) 감염", "면역 억제 상태"],
        "대처법/치료법": ["수술적 절제", "냉동치료", "광역동 치료", "국소 도포제 (5-플루오로우라실, 이미퀴모드)"],
        "추천_약": ["5-플루오로우라실(5-FU) 연고", "이미퀴모드(Imiquimod) 크림"],
        "주의사항/생활습관": ["자외선 차단", "병변 변화 주시", "조기 진단 및 치료 중요"],
        "출처": "Google 검색 (아산병원, 세브란스병원 관련 자료)"
    },
    "지루각화증": {
        "병명": "지루각화증",
        "정의": "양성 표피 종양 중 가장 흔한 형태로, '검버섯'이라고도 불립니다. 주로 중년 이후 발생하며 미용적인 문제 외에는 해롭지 않습니다.",
        "증상": ["갈색 또는 검은색의 융기된 반점", "표면이 거칠거나 기름진 느낌", "크기가 다양하고 신체 어느 부위든 발생 가능"],
        "원인": ["노화", "유전적 요인", "자외선 노출"],
        "대처법/치료법": ["대부분 치료 불필요 (양성 종양)", "미용 목적 또는 불편감 시 제거 (냉동치료, 레이저, 전기소작술, 수술)"],
        "추천_약": ["해당 없음 (약물 치료보다는 제거 시술)"],
        "주의사항/생활습관": ["갑작스러운 크기, 색깔 변화 시 피부과 진찰", "과도한 자외선 노출 피하기"],
        "출처": "Google 검색 (서울아산병원, 피부과 전문의 블로그)"
    },
    "표피낭종": {
        "병명": "표피낭종",
        "정의": "피부 아래에 발생하는 양성 종양으로, 피부의 표피 세포가 안으로 들어가 주머니를 형성하고 그 안에 각질과 피지 등의 내용물이 쌓여 생깁니다.",
        "증상": ["피부 아래에 만져지는 부드러운 혹", "중앙에 검은 점(구멍)이 있을 수 있음", "압박 시 냄새 나는 치즈 같은 내용물 분비 가능", "염증 발생 시 통증, 발적, 부기 동반"],
        "원인": ["피부 표피 세포가 진피층으로 유입", "모낭의 손상", "유전적 요인"],
        "대처법/치료법": ["염증이 없는 경우 치료 불필요", "염증 시 항생제 복용 또는 배농", "완전한 제거를 위해 수술적 절제"],
        "추천_약": ["염증 발생 시 항생제 (의사 처방)", "소염 진통제"],
        "주의사항/생활습관": ["억지로 짜지 않기 (염증 악화 가능성)", "청결 유지"],
        "출처": "Google 검색 (아산병원, 삼성서울병원 관련 자료)"
    },
    "피부섬유종": {
        "병명": "피부섬유종",
        "정의": "피부 진피층에 발생하는 양성 종양으로, 딱딱하고 결절 형태로 나타나며 주로 팔다리에 발생합니다.",
        "증상": ["피부 아래에 만져지는 단단한 결절", "갈색, 붉은색 또는 피부색", "중앙을 누르면 주변 피부가 움푹 들어가는 '딤플 사인(dimple sign)'", "가려움증이나 통증 동반 가능"],
        "원인": ["정확한 원인 불명", "벌레 물림, 모낭염 등 가벼운 피부 손상 후 발생 추정"],
        "대처법/치료법": ["대부분 치료 불필요 (양성 종양)", "미용 목적 또는 불편감 시 수술적 절제"],
        "추천_약": ["해당 없음 (약물 치료보다는 수술적 제거)"],
        "주의사항/생활습관": ["갑작스러운 크기 변화나 통증 발생 시 피부과 진찰"],
        "출처": "Google 검색 (서울대학교병원, 피부과 전문의 블로그)"
    },
    "흑색점": {
        "병명": "흑색점",
        "정의": "피부에 멜라닌 색소가 과도하게 침착되어 나타나는 갈색 또는 검은색 반점입니다. 일반적인 '점'의 한 형태이며, 악성 흑색종과는 구별됩니다.",
        "증상": ["원형 또는 타원형의 균일한 갈색 또는 검은색 반점", "대부분 작고 평평함", "신체 어느 부위든 발생 가능"],
        "원인": ["유전적 요인", "자외선 노출", "피부 노화"],
        "대처법/치료법": ["대부분 치료 불필요 (양성 병변)", "미용 목적 시 레이저 치료 또는 수술적 제거", "악성 변화 의심 시 조직검사"],
        "추천_약": ["해당 없음 (약물 치료보다는 제거 시술)"],
        "주의사항/생활습관": ["점의 모양, 크기, 색깔 변화 주시 (비대칭성, 불규칙한 경계, 색깔 변화, 지름 6mm 이상, 크기 변화 - ABCDE 규칙)", "새로운 점이 생기거나 기존 점에 이상이 있을 시 피부과 진찰"],
        "출처": "Google 검색 (대한피부과의사회, 삼성서울병원 관련 자료)"
    },
    "화농_육아종": {
        "병명": "화농_육아종",
        "정의": "피부나 점막에 발생하는 양성 혈관 증식성 병변으로, 이름과는 달리 감염이 아닌 과도한 모세혈관 증식에 의해 생깁니다.",
        "증상": ["빠르게 자라는 붉은색 또는 검붉은색의 혹", "표면이 잘 허물어져 쉽게 출혈", "주로 손가락, 얼굴, 입술 등에 발생"],
        "원인": ["외상 (경미한 상처, 벌레 물림 등)", "호르몬 변화 (임신 중)"],
        "대처법/치료법": ["수술적 절제", "레이저 치료", "냉동치료", "전기소작술"],
        "추천_약": ["해당 없음 (약물 치료보다는 제거 시술)"],
        "주의사항/생활습관": ["출혈이 잦을 경우 제거 고려", "재발 가능성 있음"],
        "출처": "Google 검색 (대한피부과의사회, 세브란스병원 관련 자료)"
    }
}


disease_list = [
    "건선", "광선_각화증", "기저세포암", "멜라닌_세포모반", "보웬병", "비립종", "사마귀",
    "아토피", "악성흑색종", "여드름", "주사", "지루", "지루각화증",
    "편평세포암", "표피낭종", "피부섬유종", "피지샘증식증", "혈관종", "화농_육아종", "흑색점"
]

all_diseases_data = []

for disease in disease_list:
    # manual_disease_info의 키는 disease_list의 이름과 정확히 일치하도록 조정
    if disease in manual_disease_info:
        data = manual_disease_info[disease]
        print(f"'{disease}' 정보 수동 정의 데이터 사용.")
        all_diseases_data.append(data)
        time.sleep(0.1) # 빠르게 처리되므로 딜레이 짧게
        continue # 다음 병명으로 넘어감

    # 수동 정의된 정보가 없으면 위키백과 크롤링 시도
    # 이 부분은 이제 manual_disease_info에 없는 병명들(건선, 기저세포암, 비립종, 사마귀, 아토피, 악성흑색종, 여드름, 주사, 지루, 편평세포암, 피지샘증식증, 혈관종)만 처리합니다.
    search_query = disease.replace(" ", "").replace("_", "") 

    if disease == "주사": # '주사'는 '주사비'로 검색해야 위키백과 페이지가 있음
        search_query = "주사비"
    elif disease == "지루": # '지루'는 '지루성_피부염'으로 검색해야 위키백과 페이지가 있음
        search_query = "지루성_피부염"
    
    
    print(f"'{disease}'에 대해 '{search_query}'로 검색 시도...")
    data = get_wiki_data(search_query)
    
    if data:
        all_diseases_data.append(data)
    
    time.sleep(1) # 요청 간격을 1초로 유지

with open("skin_disease_data.json", "w", encoding="utf-8") as f:
    json.dump(all_diseases_data, f, ensure_ascii=False, indent=4)

print("\n모든 데이터 수집 시도 완료. 성공적으로 수집된 데이터는 'skin_disease_data.json'에 저장되었습니다.")
print(f"총 {len(disease_list)}개 병명 중 {len(all_diseases_data)}개 병명에 대한 정보 수집 완료.")